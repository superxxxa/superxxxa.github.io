<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰å¯†å®¤ï¼šå°‹æ‰¾å¤±è½çš„å°ç£ç¸£ç½²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            @media (max-width: 768px) {
                .successContent {
                    padding: 20px;
                }
                
                .successContent h1 {
                    font-size: 24px;
                }
                
                .buttonGroup {
                    flex-direction: column;
                    width: 100%;
                }
                
                .actionButton {
                    width: 100%;
                }
            }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #222;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* éŠæˆ²å®¹å™¨ */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨UI */
        #topUI {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 3px solid #4CC3D9;
        }

        #sceneTitle {
            font-size: 24px;
            color: #4CC3D9;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #timer {
            font-size: 20px;
            color: #FFD700;
            font-weight: bold;
        }

        /* ä¸»å ´æ™¯å€åŸŸ */
        #sceneArea {
            flex: 1;
            position: relative;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: filter 0.3s;
        }

        /* åº•éƒ¨ç‰©å“æ¬„ */
        #inventory {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: rgba(0,0,0,0.9);
            border-top: 3px solid #4CC3D9;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 20px;
            z-index: 100;
        }

        .inventorySlot {
            width: 80px;
            height: 80px;
            border: 2px solid #666;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .inventorySlot:hover {
            border-color: #4CC3D9;
            transform: scale(1.1);
        }

        .inventorySlot.filled {
            border-color: #FFD700;
            background: rgba(255,215,0,0.2);
        }

        .inventoryItem {
            font-size: 40px;
        }

        .itemTooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 14px;
            display: none;
            color: #FFD700;
        }

        .inventorySlot:hover .itemTooltip {
            display: block;
        }

        /* å¯é»æ“Šç‰©ä»¶ */
        .clickable {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clickable:hover {
            filter: brightness(1.3) drop-shadow(0 0 20px rgba(255,255,255,0.8));
            transform: scale(1.05);
        }

        .clickable.glow {
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 10px rgba(255,215,0,0.5)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,215,0,0.8)); }
        }

        /* å°è©±æ¡† */
        #messageBox {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 30px;
            border-radius: 10px;
            border: 2px solid #4CC3D9;
            max-width: 600px;
            text-align: center;
            display: none;
            z-index: 200;
            font-size: 18px;
            line-height: 1.5;
        }

        /* è¬é¡Œä»‹é¢ */
        #puzzleModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .puzzleContent {
            background: #333;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #4CC3D9;
            max-width: 600px;
            text-align: center;
        }

        .puzzleContent h3 {
            color: #4CC3D9;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .puzzleContent input {
            padding: 10px 20px;
            font-size: 18px;
            border: 2px solid #666;
            border-radius: 5px;
            background: #222;
            color: white;
            margin: 10px;
            text-align: center;
        }

        .puzzleContent button {
            padding: 10px 30px;
            font-size: 18px;
            background: #4CC3D9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        .puzzleContent button:hover {
            background: #3BA3B9;
            transform: scale(1.05);
        }

        /* é–‹å§‹ç•«é¢ */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
        }

        .startContent {
            background: #222;
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #4CC3D9;
            max-width: 700px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .startContent h1 {
            color: #4CC3D9;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .startContent h2 {
            color: #FFD700;
            margin: 20px 0 10px;
            font-size: 24px;
        }

        .startContent p {
            line-height: 1.8;
            margin: 10px 0;
            font-size: 18px;
        }

        .missionBox {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .missionBox h3 {
            color: #4CC3D9;
            margin-bottom: 10px;
        }

        #startBtn {
            padding: 15px 40px;
            font-size: 24px;
            background: #4CC3D9;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        #startBtn:hover {
            background: #3BA3B9;
            transform: scale(1.1);
        }

        /* å ´æ™¯åˆ‡æ›å‹•ç•« */
        .sceneTransition {
            animation: fadeInOut 1s;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* æˆåŠŸå‹•ç•« */
        .success {
            animation: successPulse 0.5s;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* å¯†ç¢¼é– */
        .lockDisplay {
            font-size: 48px;
            font-family: 'Courier New', monospace;
            color: #FFD700;
            margin: 20px 0;
            letter-spacing: 10px;
        }

        /* è—é ­è©© */
        .poem {
            font-size: 24px;
            line-height: 2;
            margin: 20px 0;
            text-align: left;
            display: inline-block;
        }

        .poem .firstChar {
            color: #FFD700;
            font-weight: bold;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* åœ°åœ– */
        #mapContainer {
            position: relative;
            width: 500px;
            height: 400px;
            margin: 20px auto;
            background: #444;
            border: 2px solid #666;
            border-radius: 10px;
        }

        .mapMarker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mapMarker:hover {
            transform: scale(1.2);
        }

        #chicanMarker {
            background: #DC143C;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #countyMarker {
            background: #FFD700;
            top: 40%;
            left: 60%;
            cursor: move;
        }

        /* æˆåŠŸç•«é¢ */
        #successScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .successContent {
            background: #222;
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #FFD700;
            max-width: 800px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .successContent h1 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 36px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .successContent img {
            max-width: 100%;
            height: auto;
            margin: 20px 0;
            border: 2px solid #666;
            border-radius: 10px;
        }

        .buttonGroup {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .actionButton {
            padding: 15px 30px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .restartButton {
            background: #4CC3D9;
            color: white;
        }

        .restartButton:hover {
            background: #3BA3B9;
            transform: scale(1.05);
        }

        .exitButton {
            background: #DC143C;
            color: white;
        }

        .exitButton:hover {
            background: #B91C1C;
            transform: scale(1.05);
        }

        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 768px) {
            #topUI {
                flex-direction: column;
                gap: 10px;
            }
            
            #sceneTitle {
                font-size: 18px;
            }
            
            #inventory {
                height: 80px;
                padding: 5px 10px;
            }
            
            .inventorySlot {
                width: 60px;
                height: 60px;
            }
            
            .inventoryItem {
                font-size: 30px;
            }
            
            #messageBox {
                font-size: 16px;
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- é–‹å§‹ç•«é¢ -->
    <div id="startScreen">
        <div class="startContent">
            <h1>ğŸ” æ™‚å…‰å¯†å®¤ï¼šå°‹æ‰¾å¤±è½çš„å°ç£ç¸£ç½²</h1>
            
            <h2>ğŸ“– æ•…äº‹èƒŒæ™¯</h2>
            <p>ä½ è¢«å›°åœ¨ä¸€å€‹ç¥ç§˜çš„æ™‚å…‰å¯†å®¤è£¡ï¼è¦é€ƒå‡ºå»ï¼Œå¿…é ˆç©¿è¶Š4å€‹ä¸åŒæ™‚ä»£çš„æˆ¿é–“ï¼Œæ‰¾å‡ºå°ç£ç¸£ç½²çš„ç§˜å¯†ã€‚æ¯å€‹æˆ¿é–“éƒ½æœ‰ä¸€å€‹è¬é¡Œï¼Œè§£é–‹å¾Œæ‰èƒ½é€²å…¥ä¸‹ä¸€å€‹æˆ¿é–“ã€‚</p>
            
            <h2>ğŸ® æ€éº¼ç©ï¼Ÿ</h2>
            <p>ğŸ‘† é»æ“Šç•«é¢ä¸Šç™¼å…‰çš„ç‰©å“æ”¶é›†ç·šç´¢<br>
            ğŸ“¦ æ”¶é›†çš„ç‰©å“æœƒå‡ºç¾åœ¨ä¸‹æ–¹ç‰©å“æ¬„<br>
            ğŸ” é»æ“Šç‰©å“æ¬„çš„æ±è¥¿å¯ä»¥æŸ¥çœ‹è©³æƒ…<br>
            ğŸ§© è§£é–‹æ¯å€‹æˆ¿é–“çš„è¬é¡Œæ‰èƒ½å‰é€²</p>
            
            <h2>ğŸ¯ å››å€‹å¯†å®¤æŒ‘æˆ°</h2>
            <div class="missionBox">
                <h3>ğŸº ç¬¬1é—œï¼šè€ƒå¤å¯†å®¤</h3>
                <p>æ‰¾å‡ºçŸ³ç¢‘ä¸Šçš„ç¥ç§˜æ•¸å­—ï¼Œé€™æ˜¯é–‹å•Ÿæ™‚å…‰ä¹‹é–€çš„å¯†ç¢¼ï¼</p>
            </div>
            
            <div class="missionBox">
                <h3>ğŸ›ï¸ ç¬¬2é—œï¼šå¤ä»£å®˜åºœå¯†å®¤</h3>
                <p>ç ´è§£ç‰†ä¸Šè©©å¥çš„ç§˜å¯†ï¼Œæ‰¾å‡ºé€™æ£Ÿå»ºç¯‰çš„çœŸæ­£åå­—ï¼</p>
            </div>
            
            <div class="missionBox">
                <h3>ğŸ« ç¬¬3é—œï¼šæ—¥å¼æ•™å®¤å¯†å®¤</h3>
                <p>è§£é–‹é»‘æ¿ä¸Šçš„æ‘©æ–¯å¯†ç¢¼ï¼Œç™¼ç¾é‡è¦çš„åœ°åï¼</p>
            </div>
            
            <div class="missionBox">
                <h3>ğŸ—ºï¸ ç¬¬4é—œï¼šåœ°åœ–å¯†å®¤</h3>
                <p>åœ¨å¤åœ°åœ–ä¸Šæ¨™è¨˜å‡ºç¸£ç½²çš„æ­£ç¢ºä½ç½®ï¼Œé–‹å•Ÿæœ€çµ‚çš„é€ƒè„«ä¹‹é–€ï¼</p>
            </div>
            
            <p style="color: #FFD700; font-size: 20px; margin-top: 20px;">
                â±ï¸ é™æ™‚15åˆ†é˜ï¼ä½ èƒ½æˆåŠŸé€ƒè„«å—ï¼Ÿ
            </p>
            
            <p style="font-size: 14px; color: #888; margin-top: 15px;">
                ğŸ“Š æœ¬éŠæˆ²æœƒè¨˜éŒ„æ‚¨çš„æ“ä½œéç¨‹ä»¥æ”¹å–„éŠæˆ²é«”é©—
            </p>
            
            <button id="startBtn">é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <!-- éŠæˆ²ä¸»å®¹å™¨ -->
    <div id="gameContainer" style="display: none;">
        <!-- é ‚éƒ¨UI -->
        <div id="topUI">
            <div id="sceneTitle">ç¬¬1é—œï¼šè€ƒå¤å¯†å®¤</div>
            <div id="timer">15:00</div>
        </div>

        <!-- å ´æ™¯å€åŸŸ -->
        <div id="sceneArea"></div>

        <!-- è¨Šæ¯æ¡† -->
        <div id="messageBox"></div>

        <!-- ç‰©å“æ¬„ -->
        <div id="inventory">
            <div class="inventorySlot" data-slot="0">
                <span class="itemTooltip"></span>
            </div>
            <div class="inventorySlot" data-slot="1">
                <span class="itemTooltip"></span>
            </div>
            <div class="inventorySlot" data-slot="2">
                <span class="itemTooltip"></span>
            </div>
            <div class="inventorySlot" data-slot="3">
                <span class="itemTooltip"></span>
            </div>
            <div style="flex: 1; text-align: right; padding-right: 20px;">
                <div style="font-size: 18px; color: #FFD700;">
                    æ”¶é›†é€²åº¦ï¼š<span id="progress">0/4</span>
                </div>
            </div>
        </div>
    </div>

    <!-- è¬é¡Œå½ˆçª— -->
    <div id="puzzleModal">
        <div class="puzzleContent" id="puzzleContent">
            <!-- å‹•æ…‹å…§å®¹ -->
        </div>
    </div>

    <!-- æˆåŠŸç•«é¢ -->
    <div id="successScreen">
        <div class="successContent">
            <h1>ğŸŠ æ­å–œæˆåŠŸé€ƒè„«ï¼</h1>
            <p style="font-size: 20px; color: #4CC3D9; margin-bottom: 20px;">
                ä½ æˆåŠŸæ‰¾åˆ°äº†å¤±è½çš„å°ç£ç¸£ç½²ï¼
            </p>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ“œ æ­·å²æ­å¯†</h2>
                <p style="text-align: left; line-height: 1.8;">
                    <strong>å°ç£ç¸£ç½²</strong>æ˜¯æ¸…æœæ™‚æœŸçš„ç¸£ç´šè¡Œæ”¿ä¸­å¿ƒï¼Œå»ºæ–¼1684å¹´ã€‚<br>
                    ğŸ“ ä½ç½®ï¼šèµ¤å´æ¨“æ±åŒ—æ–¹ï¼ˆä»ŠæˆåŠŸåœ‹å°é™„è¿‘ï¼‰<br>
                    ğŸ›ï¸ åŠŸèƒ½ï¼šè™•ç†åœ°æ–¹è¡Œæ”¿ã€å¸æ³•ç­‰äº‹å‹™<br>
                    ğŸ“… æ­·å²ï¼šå¾æ¸…æœåˆ°æ—¥æ²»æ™‚æœŸï¼Œè¦‹è­‰äº†å°å—çš„æ­·å²è®Šé·
                </p>
            </div>
            
            <h3 style="color: #4CC3D9; margin: 20px 0;">é€™æ˜¯1807å¹´ã€ŠçºŒä¿®å°ç£ç¸£èªŒã€‹ä¸­è¨˜è¼‰çš„ç¸£ç½²å»ºç¯‰åœ–ï¼š</h3>
            
            <!-- ç¸£ç½²å»ºç¯‰åœ– -->
            <img id="countyImage" alt="å°ç£ç¸£ç½²å»ºç¯‰åœ–" style="background: white; padding: 10px;">
            
            <!-- å¦‚éœ€ä½¿ç”¨çœŸå¯¦åœ–ç‰‡ï¼Œè«‹å°‡ä¸‹è¡Œè¨»è§£ç§»é™¤ä¸¦å¡«å…¥åœ–ç‰‡URL -->
            <!-- <img src="æ‚¨çš„ç¸£ç½²åœ–ç‰‡URL" alt="å°ç£ç¸£ç½²å»ºç¯‰åœ–" style="max-width: 100%; height: auto;"> -->
            
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left;">
                <p style="font-size: 16px; line-height: 1.8;">
                    ğŸ“ <strong>å»ºç¯‰èªªæ˜ï¼š</strong><br>
                    é€™å¼µåœ–å±•ç¤ºäº†å‚³çµ±çš„ä¸­å¼å®˜ç½²å»ºç¯‰æ ¼å±€ï¼ŒåŒ…å«å¤§é–€ã€ä¸­åº­ã€æ­£å ‚å’Œæ±è¥¿å»‚æˆ¿ã€‚<br>
                    é€™ç¨®ã€Œä¸‰é€²å…©é™¢ã€çš„è¨­è¨ˆæ˜¯æ¸…ä»£å®˜ç½²çš„å…¸å‹é…ç½®ã€‚
                </p>
            </div>
            
            <p style="margin-top: 20px; color: #FFD700;">
                â±ï¸ å®Œæˆæ™‚é–“ï¼š<span id="completionTime"></span>
            </p>
            
            <div class="buttonGroup">
                <button class="actionButton restartButton" onclick="restartGame()">
                    ğŸ”„ é‡æ–°æŒ‘æˆ°
                </button>
                <button class="actionButton exitButton" onclick="exitGame()">
                    ğŸšª é›¢é–‹éŠæˆ²
                </button>
            </div>
        </div>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            currentScene: 1,
            timeRemaining: 900, // 15åˆ†é˜
            inventory: [],
            puzzlesSolved: {
                scene1: false,
                scene2: false,
                scene3: false,
                scene4: false
            },
            foundItems: {
                stonePlate: false,
                poem: false,
                morse: false,
                map: false
            },
            playerId: '', // ç©å®¶ID
            startTime: null, // é–‹å§‹æ™‚é–“
            actions: [] // æ“ä½œè¨˜éŒ„
        };

        let timerInterval;
        let draggedMarker = null;
        
        // Google Apps Script Web App URL (éœ€è¦æä¾›)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVdNQTsfAn4ggsBKHGKRx5DrOVEzEhzMIYI3-319f5LJvz056SWCx1G1_EOC1vY6CV-g/exec';

        // å ´æ™¯è³‡æ–™
        const scenes = {
            1: {
                title: 'ç¬¬1é—œï¼šè€ƒå¤å¯†å®¤',
                background: 'linear-gradient(to bottom, #8B7355 0%, #654321 100%)',
                description: 'é€™æ˜¯ä¸€å€‹å……æ»¿å¡µåœŸçš„è€ƒå¤ç¾å ´ï¼Œç‰†ä¸Šæœ‰å¤è€çš„åœ°åœ–ï¼Œåœ°ä¸Šæ•£è½è‘—è€ƒå¤å·¥å…·...',
                items: [
                    {
                        id: 'stonePlate',
                        emoji: 'ğŸ—¿',
                        name: 'ç¥ç§˜çŸ³ç¢‘',
                        description: 'ä¸Šé¢åˆ»è‘—ï¼šä¸€å…­å…«å››',
                        position: { left: '30%', top: '40%' },
                        clickAction: 'showPuzzle1'
                    },
                    {
                        id: 'map1875',
                        emoji: 'ğŸ—ºï¸',
                        name: '1875å¹´åœ°åœ–',
                        description: 'å°ç£åºœåŸè¡—é“åœ–',
                        position: { left: '70%', top: '30%' },
                        clickAction: 'collectItem'
                    },
                    {
                        id: 'brush',
                        emoji: 'ğŸ–Œï¸',
                        name: 'è€ƒå¤åˆ·',
                        description: 'ç”¨ä¾†æ¸…ç†æ–‡ç‰©çš„å·¥å…·',
                        position: { left: '50%', top: '60%' },
                        clickAction: 'showMessage'
                    }
                ]
            },
            2: {
                title: 'ç¬¬2é—œï¼šå¤ä»£å®˜åºœå¯†å®¤',
                background: 'linear-gradient(to bottom, #8B4513 0%, #654321 100%)',
                description: 'é€™è£¡æ˜¯æ¸…æœçš„å®˜åºœå¤§å»³ï¼Œæœ‰å®˜å“¡è¾¦å…¬çš„æ¡Œæ¤…ï¼Œç‰†ä¸Šæ›è‘—è©©è©...',
                items: [
                    {
                        id: 'poemWall',
                        emoji: 'ğŸ“œ',
                        name: 'ç‰†ä¸Šçš„è©©',
                        description: 'ä¸€é¦–è—é ­è©©',
                        position: { left: '50%', top: '35%' },
                        clickAction: 'showPuzzle2'
                    },
                    {
                        id: 'seal',
                        emoji: 'ğŸ®',
                        name: 'å®˜å°',
                        description: 'ç¸£å®˜çš„å°ç« ',
                        position: { left: '20%', top: '50%' },
                        clickAction: 'collectItem'
                    },
                    {
                        id: 'document',
                        emoji: 'ğŸ“‹',
                        name: 'å…¬æ–‡',
                        description: 'çºŒä¿®å°ç£ç¸£èªŒ',
                        position: { left: '80%', top: '45%' },
                        clickAction: 'showMessage'
                    }
                ]
            },
            3: {
                title: 'ç¬¬3é—œï¼šæ—¥å¼æ•™å®¤å¯†å®¤',
                background: 'linear-gradient(to bottom, #F5DEB3 0%, #D2691E 100%)',
                description: 'é€™æ˜¯æ—¥æ²»æ™‚æœŸçš„æ•™å®¤ï¼Œé»‘æ¿ä¸Šå¯«è‘—å¥‡æ€ªçš„ç¬¦è™Ÿ...',
                items: [
                    {
                        id: 'blackboard',
                        emoji: 'ğŸ“',
                        name: 'é»‘æ¿',
                        description: 'ä¸Šé¢æœ‰æ‘©æ–¯å¯†ç¢¼',
                        position: { left: '50%', top: '30%' },
                        clickAction: 'showPuzzle3'
                    },
                    {
                        id: 'textbook',
                        emoji: 'ğŸ“š',
                        name: 'èª²æœ¬',
                        description: 'æ—¥æ–‡æ•™ç§‘æ›¸',
                        position: { left: '25%', top: '55%' },
                        clickAction: 'collectItem'
                    },
                    {
                        id: 'abacus',
                        emoji: 'ğŸ§®',
                        name: 'ç®—ç›¤',
                        description: 'å¤è€çš„è¨ˆç®—å·¥å…·',
                        position: { left: '75%', top: '50%' },
                        clickAction: 'showMessage'
                    }
                ]
            },
            4: {
                title: 'ç¬¬4é—œï¼šåœ°åœ–å¯†å®¤',
                background: 'linear-gradient(to bottom, #1E90FF 0%, #000080 100%)',
                description: 'æœ€å¾Œçš„å¯†å®¤ï¼ç‰†ä¸Šæœ‰ä¸€å¹…å·¨å¤§çš„3Dåœ°åœ–ï¼Œå¿…é ˆæ¨™è¨˜å‡ºæ­£ç¢ºçš„ä½ç½®...',
                items: [
                    {
                        id: 'finalMap',
                        emoji: 'ğŸ—¾',
                        name: 'ç«‹é«”åœ°åœ–',
                        description: 'æ¨™è¨˜ç¸£ç½²ä½ç½®',
                        position: { left: '50%', top: '40%' },
                        clickAction: 'showPuzzle4'
                    }
                ]
            }
        };

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            // ç”Ÿæˆç©å®¶ID
            gameState.playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            document.getElementById('startBtn').addEventListener('click', startGame);
            
            // ç‰©å“æ¬„é»æ“Šäº‹ä»¶
            document.querySelectorAll('.inventorySlot').forEach(slot => {
                slot.addEventListener('click', function() {
                    const index = parseInt(this.dataset.slot);
                    if (gameState.inventory[index]) {
                        const item = gameState.inventory[index];
                        showMessage(`é€™æ˜¯${item.name}ï¼š${item.description}`);
                        // è¨˜éŒ„æŸ¥çœ‹ç‰©å“
                        trackAction('view_inventory', item.name, `æŸ¥çœ‹ç‰©å“ï¼š${item.name}`);
                    }
                });
            });
        }

        // è¿½è¹¤å‹•ä½œ
        function trackAction(actionType, itemName = '', note = '') {
            const action = {
                actionType: actionType,
                itemName: itemName,
                scene: gameState.currentScene,
                gameTime: gameState.startTime ? Math.floor((Date.now() - gameState.startTime) / 1000) : 0,
                note: note,
                timestamp: new Date().toISOString()
            };
            
            gameState.actions.push(action);
            
            // å³æ™‚ç™¼é€åˆ°Google Sheets
            sendToGoogleSheets(action);
        }

        // ç™¼é€è³‡æ–™åˆ°Google Sheets
        function sendToGoogleSheets(action) {
            // å¦‚æœæ²’æœ‰è¨­å®šURLï¼Œåªåœ¨consoleè¨˜éŒ„
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                console.log('è¿½è¹¤å‹•ä½œ:', action);
                return;
            }
            
            const data = {
                playerId: gameState.playerId,
                ...action
            };
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // é¿å…CORSå•é¡Œ
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                console.log('è³‡æ–™å·²é€å‡º');
            })
            .catch(error => {
                console.error('ç™¼é€å¤±æ•—:', error);
            });
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            
            // è¨˜éŒ„é–‹å§‹æ™‚é–“
            gameState.startTime = Date.now();
            
            // è¨˜éŒ„éŠæˆ²é–‹å§‹
            trackAction('game_started', '', 'éŠæˆ²é–‹å§‹');
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨
            startTimer();
            
            // è¼‰å…¥ç¬¬ä¸€å€‹å ´æ™¯
            loadScene(1);
            
            // æ’­æ”¾é–‹å§‹éŸ³æ•ˆ
            playSound('start');
        }

        // è¨ˆæ™‚å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimer();
                
                if (gameState.timeRemaining <= 0) {
                    endGame(false);
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // è¼‰å…¥å ´æ™¯
        function loadScene(sceneNum) {
            const scene = scenes[sceneNum];
            const sceneArea = document.getElementById('sceneArea');
            
            // è¨˜éŒ„å ´æ™¯åˆ‡æ›
            if (gameState.currentScene !== sceneNum) {
                trackAction('scene_changed', `å ´æ™¯${sceneNum}`, `é€²å…¥${scene.title}`);
            }
            
            // æ¸…ç©ºå ´æ™¯
            sceneArea.innerHTML = '';
            sceneArea.style.background = scene.background;
            sceneArea.classList.add('sceneTransition');
            
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('sceneTitle').textContent = scene.title;
            gameState.currentScene = sceneNum;
            
            // é¡¯ç¤ºå ´æ™¯æè¿°
            showMessage(scene.description);
            
            // æ·»åŠ å ´æ™¯ç‰©å“
            scene.items.forEach(item => {
                if (!gameState.foundItems[item.id] || item.clickAction.includes('Puzzle')) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'clickable glow';
                    itemElement.innerHTML = `<span style="font-size: 60px;">${item.emoji}</span>`;
                    itemElement.style.left = item.position.left;
                    itemElement.style.top = item.position.top;
                    itemElement.dataset.itemId = item.id;
                    
                    itemElement.addEventListener('click', () => handleItemClick(item));
                    
                    sceneArea.appendChild(itemElement);
                }
            });
            
            setTimeout(() => {
                sceneArea.classList.remove('sceneTransition');
            }, 1000);
        }

        // è™•ç†ç‰©å“é»æ“Š
        function handleItemClick(item) {
            // è¨˜éŒ„é»æ“Šç‰©å“
            trackAction('click_item', item.name, `é»æ“Šç‰©å“ï¼š${item.name}`);
            
            switch(item.clickAction) {
                case 'collectItem':
                    collectItem(item);
                    break;
                case 'showMessage':
                    showMessage(item.description);
                    break;
                case 'showPuzzle1':
                    showPuzzle1();
                    break;
                case 'showPuzzle2':
                    showPuzzle2();
                    break;
                case 'showPuzzle3':
                    showPuzzle3();
                    break;
                case 'showPuzzle4':
                    showPuzzle4();
                    break;
            }
        }

        // æ”¶é›†ç‰©å“
        function collectItem(item) {
            if (gameState.foundItems[item.id]) return;
            
            gameState.foundItems[item.id] = true;
            gameState.inventory.push(item);
            
            // è¨˜éŒ„æ”¶é›†ç‰©å“
            trackAction('item_collected', item.name, `æ”¶é›†äº†${item.name}`);
            
            // æ›´æ–°ç‰©å“æ¬„
            updateInventory();
            
            // ç§»é™¤å ´æ™¯ä¸­çš„ç‰©å“
            const itemElement = document.querySelector(`[data-item-id="${item.id}"]`);
            if (itemElement) {
                itemElement.classList.add('success');
                setTimeout(() => itemElement.remove(), 500);
            }
            
            showMessage(`ç²å¾—äº† ${item.name}ï¼`);
            playSound('collect');
            
            // æ›´æ–°é€²åº¦
            updateProgress();
        }

        // æ›´æ–°ç‰©å“æ¬„
        function updateInventory() {
            gameState.inventory.forEach((item, index) => {
                const slot = document.querySelector(`[data-slot="${index}"]`);
                if (slot) {
                    slot.innerHTML = `
                        <span class="inventoryItem">${item.emoji}</span>
                        <span class="itemTooltip">${item.name}</span>
                    `;
                    slot.classList.add('filled');
                }
            });
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // è¬é¡Œ1ï¼šçŸ³ç¢‘å¯†ç¢¼
        function showPuzzle1() {
            const modal = document.getElementById('puzzleModal');
            const content = document.getElementById('puzzleContent');
            
            content.innerHTML = `
                <h3>ğŸ—¿ çŸ³ç¢‘ä¸Šçš„å¯†ç¢¼</h3>
                <p>çŸ³ç¢‘ä¸Šåˆ»è‘—å››å€‹æ•¸å­—ï¼Œé€™ä¼¼ä¹æ˜¯æŸå€‹é‡è¦çš„å¹´ä»½...</p>
                <div class="lockDisplay">ä¸€å…­å…«å››</div>
                <p>è«‹è¼¸å…¥é€™å€‹å¹´ä»½ï¼ˆé˜¿æ‹‰ä¼¯æ•¸å­—ï¼‰ï¼š</p>
                <input type="text" id="puzzle1Input" maxlength="4" style="width: 150px; font-size: 24px;">
                <br>
                <button onclick="checkPuzzle1()">ç¢ºèª</button>
                <button onclick="closePuzzle()">è¿”å›</button>
            `;
            
            modal.style.display = 'flex';
            document.getElementById('puzzle1Input').focus();
        }

        // æª¢æŸ¥è¬é¡Œ1ç­”æ¡ˆ
        function checkPuzzle1() {
            const input = document.getElementById('puzzle1Input').value;
            
            // è¨˜éŒ„è¬é¡Œå˜—è©¦
            trackAction('puzzle_attempt', 'çŸ³ç¢‘å¯†ç¢¼', `å˜—è©¦ç­”æ¡ˆï¼š${input}`);
            
            if (input === '1684') {
                gameState.puzzlesSolved.scene1 = true;
                trackAction('puzzle_solved', 'çŸ³ç¢‘å¯†ç¢¼', 'æˆåŠŸè§£é–‹çŸ³ç¢‘å¯†ç¢¼');
                closePuzzle();
                showMessage('âœ¨ è§£é–‹äº†ï¼1684å¹´æ˜¯å°ç£è¨­ç«‹åºœç¸£çš„é‡è¦å¹´ä»½ï¼');
                playSound('success');
                
                // æ”¶é›†çŸ³ç¢‘
                const stonePlate = scenes[1].items.find(item => item.id === 'stonePlate');
                collectItem(stonePlate);
                
                // 3ç§’å¾Œé€²å…¥ä¸‹ä¸€é—œ
                setTimeout(() => {
                    showMessage('å¯†å®¤çš„é–€æ‰“é–‹äº†ï¼é€²å…¥ä¸‹ä¸€å€‹æˆ¿é–“...');
                    setTimeout(() => loadScene(2), 1500);
                }, 2000);
            } else {
                trackAction('puzzle_failed', 'çŸ³ç¢‘å¯†ç¢¼', `éŒ¯èª¤ç­”æ¡ˆï¼š${input}`);
                showMessage('âŒ å¯†ç¢¼éŒ¯èª¤ï¼å†ä»”ç´°çœ‹çœ‹çŸ³ç¢‘ä¸Šçš„æ•¸å­—...');
                playSound('error');
            }
        }

        // è¬é¡Œ2ï¼šè—é ­è©©
        function showPuzzle2() {
            const modal = document.getElementById('puzzleModal');
            const content = document.getElementById('puzzleContent');
            
            content.innerHTML = `
                <h3>ğŸ“œ ç¥ç§˜çš„è—é ­è©©</h3>
                <div class="poem">
                    <span class="firstChar">å°</span>å³¶åˆè¨­åºœ<br>
                    <span class="firstChar">ç£</span>å²¸ç¯‰æ–°åŸ<br>
                    <span class="firstChar">ç¸£</span>å®˜ç†æ°‘äº‹<br>
                    <span class="firstChar">ç½²</span>å…§åˆ¤å…¬æ˜
                </div>
                <p>æ¯å¥è©©çš„ç¬¬ä¸€å€‹å­—é€£èµ·ä¾†æ˜¯ä»€éº¼ï¼Ÿ</p>
                <input type="text" id="puzzle2Input" maxlength="10" style="width: 200px;">
                <br>
                <button onclick="checkPuzzle2()">ç¢ºèª</button>
                <button onclick="closePuzzle()">è¿”å›</button>
            `;
            
            modal.style.display = 'flex';
            document.getElementById('puzzle2Input').focus();
        }

        // æª¢æŸ¥è¬é¡Œ2ç­”æ¡ˆ
        function checkPuzzle2() {
            const input = document.getElementById('puzzle2Input').value;
            if (input === 'å°ç£ç¸£ç½²' || input === 'è‡ºç£ç¸£ç½²') {
                gameState.puzzlesSolved.scene2 = true;
                closePuzzle();
                showMessage('âœ¨ å¤ªæ£’äº†ï¼åŸä¾†é€™è£¡å°±æ˜¯ã€Œå°ç£ç¸£ç½²ã€ï¼');
                playSound('success');
                
                // æ”¶é›†è©©è©
                const poem = scenes[2].items.find(item => item.id === 'poemWall');
                collectItem(poem);
                
                // é€²å…¥ä¸‹ä¸€é—œ
                setTimeout(() => {
                    showMessage('åˆä¸€æ‰‡é–€æ‰“é–‹äº†ï¼ç¹¼çºŒå‰é€²...');
                    setTimeout(() => loadScene(3), 1500);
                }, 2000);
            } else {
                showMessage('âŒ ä¸å°å–”ï¼çœ‹çœ‹æ¯å¥è©©çš„ç¬¬ä¸€å€‹å­—...');
                playSound('error');
            }
        }

        // è¬é¡Œ3ï¼šæ‘©æ–¯å¯†ç¢¼
        function showPuzzle3() {
            const modal = document.getElementById('puzzleModal');
            const content = document.getElementById('puzzleContent');
            
            content.innerHTML = `
                <h3>ğŸ“ é»‘æ¿ä¸Šçš„æ‘©æ–¯å¯†ç¢¼</h3>
                <p>é»‘æ¿ä¸Šå¯«è‘—ï¼š</p>
                <div style="font-family: monospace; font-size: 24px; margin: 20px 0;">
                    -.-. .... .. -.- .- -.
                </div>
                <p>æç¤ºï¼šé€™æ˜¯ä¸€å€‹åœ°åçš„è‹±æ–‡æ‹¼éŸ³</p>
                <p>æ‘©æ–¯å¯†ç¢¼å°ç…§è¡¨ï¼š<br>
                C = -.-.ã€€H = ....ã€€I = ..ã€€K = -.-ã€€A = .-ã€€N = -.</p>
                <input type="text" id="puzzle3Input" maxlength="10" style="width: 200px;">
                <br>
                <button onclick="checkPuzzle3()">ç¢ºèª</button>
                <button onclick="closePuzzle()">è¿”å›</button>
            `;
            
            modal.style.display = 'flex';
            document.getElementById('puzzle3Input').focus();
        }

        // æª¢æŸ¥è¬é¡Œ3ç­”æ¡ˆ
        function checkPuzzle3() {
            const input = document.getElementById('puzzle3Input').value.toUpperCase();
            if (input === 'CHIKAN' || input === 'èµ¤å´' || input === 'èµ¤åµŒ') {
                gameState.puzzlesSolved.scene3 = true;
                closePuzzle();
                showMessage('âœ¨ è§£ç¢¼æˆåŠŸï¼CHIKAN å°±æ˜¯ã€Œèµ¤å´ã€ï¼');
                playSound('success');
                
                // æ”¶é›†é»‘æ¿
                const blackboard = scenes[3].items.find(item => item.id === 'blackboard');
                collectItem(blackboard);
                
                // é€²å…¥æœ€å¾Œä¸€é—œ
                setTimeout(() => {
                    showMessage('æœ€å¾Œä¸€é“é–€é–‹å•Ÿäº†ï¼é€™æ˜¯æœ€çµ‚çš„æŒ‘æˆ°...');
                    setTimeout(() => loadScene(4), 1500);
                }, 2000);
            } else {
                showMessage('âŒ å†è©¦è©¦çœ‹ï¼ç”¨å°ç…§è¡¨è§£ç¢¼...');
                playSound('error');
            }
        }

        // è¬é¡Œ4ï¼šåœ°åœ–æ¨™è¨˜
        function showPuzzle4() {
            const modal = document.getElementById('puzzleModal');
            const content = document.getElementById('puzzleContent');
            
            content.innerHTML = `
                <h3>ğŸ—¾ æ¨™è¨˜ç¸£ç½²ä½ç½®</h3>
                <p>æ ¹æ“šä½ æ”¶é›†çš„ç·šç´¢ï¼Œåœ¨åœ°åœ–ä¸Šæ¨™è¨˜å‡ºå°ç£ç¸£ç½²çš„ä½ç½®</p>
                <p>æç¤ºï¼šç¸£ç½²åœ¨èµ¤å´æ¨“çš„<strong>æ±åŒ—æ–¹</strong>ï¼ˆå³ä¸Šæ–¹ï¼‰</p>
                <div id="mapContainer">
                    <div id="chicanMarker" class="mapMarker" title="èµ¤å´æ¨“"></div>
                    <div id="countyMarker" class="mapMarker" title="æ‹–å‹•æˆ‘åˆ°æ­£ç¢ºä½ç½®"></div>
                </div>
                <button onclick="checkPuzzle4()">ç¢ºèªä½ç½®</button>
                <button onclick="closePuzzle()">è¿”å›</button>
            `;
            
            modal.style.display = 'flex';
            
            // è¨­ç½®æ‹–æ›³åŠŸèƒ½
            setupDragAndDrop();
        }

        // è¨­ç½®æ‹–æ›³åŠŸèƒ½
        function setupDragAndDrop() {
            const marker = document.getElementById('countyMarker');
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            
            marker.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = marker.getBoundingClientRect();
                const containerRect = marker.parentElement.getBoundingClientRect();
                initialLeft = rect.left - containerRect.left;
                initialTop = rect.top - containerRect.top;
                marker.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                marker.style.left = `${initialLeft + deltaX}px`;
                marker.style.top = `${initialTop + deltaY}px`;
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                if (marker) marker.style.cursor = 'move';
            });
        }

        // æª¢æŸ¥è¬é¡Œ4ç­”æ¡ˆ
        function checkPuzzle4() {
            const county = document.getElementById('countyMarker');
            const chican = document.getElementById('chicanMarker');
            
            const countyRect = county.getBoundingClientRect();
            const chicanRect = chican.getBoundingClientRect();
            
            // æª¢æŸ¥æ˜¯å¦åœ¨èµ¤å´æ¨“çš„å³ä¸Šæ–¹
            if (countyRect.left > chicanRect.left && countyRect.top < chicanRect.top) {
                gameState.puzzlesSolved.scene4 = true;
                closePuzzle();
                showMessage('ğŸ‰ å¤ªæ£’äº†ï¼ä½ æˆåŠŸæ‰¾åˆ°äº†å°ç£ç¸£ç½²çš„ä½ç½®ï¼');
                playSound('success');
                
                // æ”¶é›†åœ°åœ–ç‰©å“
                const finalMap = scenes[4].items.find(item => item.id === 'finalMap');
                collectItem(finalMap);
                
                // éŠæˆ²å‹åˆ©
                setTimeout(() => {
                    endGame(true);
                }, 2000);
            } else {
                showMessage('âŒ ä½ç½®ä¸å°ï¼è¨˜å¾—ç¸£ç½²åœ¨èµ¤å´æ¨“çš„ã€Œæ±åŒ—æ–¹ã€ï¼ˆå³ä¸Šæ–¹ï¼‰');
                playSound('error');
            }
        }

        // é—œé–‰è¬é¡Œ
        function closePuzzle() {
            document.getElementById('puzzleModal').style.display = 'none';
        }

        // æ›´æ–°é€²åº¦
        function updateProgress() {
            const progress = Object.values(gameState.foundItems).filter(v => v).length;
            document.getElementById('progress').textContent = `${progress}/4`;
        }

        // éŠæˆ²çµæŸ
        function endGame(success) {
            clearInterval(timerInterval);
            
            const totalTime = Math.floor((Date.now() - gameState.startTime) / 1000);
            
            if (success) {
                // è¨˜éŒ„éŠæˆ²å®Œæˆ
                trackAction('game_completed', '', `æˆåŠŸå®Œæˆï¼Œè€—æ™‚${totalTime}ç§’`);
                
                // è¨ˆç®—å®Œæˆæ™‚é–“
                const usedTime = 900 - gameState.timeRemaining;
                const minutes = Math.floor(usedTime / 60);
                const seconds = usedTime % 60;
                
                // é¡¯ç¤ºæˆåŠŸç•«é¢
                document.getElementById('successScreen').style.display = 'flex';
                document.getElementById('completionTime').textContent = 
                    `${minutes}åˆ†${seconds}ç§’`;
                
                // ç™¼é€å®Œæ•´éŠæˆ²è¨˜éŒ„
                sendGameSummary(true, totalTime);
                
                // è¨­ç½®ç¸£ç½²åœ–ç‰‡ - ä½¿ç”¨SVGç¹ªè£½ä»¿å¤å»ºç¯‰åœ–
                const svgContent = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600" style="background: #f5f5dc;">
                        <!-- å¤–åœé‚Šæ¡† -->
                        <rect x="50" y="50" width="700" height="500" fill="none" stroke="#000" stroke-width="3"/>
                        
                        <!-- ä¸»å»ºç¯‰ç¾¤ -->
                        <!-- å‰å»³ -->
                        <rect x="300" y="450" width="200" height="80" fill="none" stroke="#000" stroke-width="2"/>
                        <text x="400" y="495" text-anchor="middle" font-size="20" font-family="serif">å¤§é–€</text>
                        
                        <!-- ä¸­åº­ -->
                        <rect x="200" y="300" width="400" height="120" fill="none" stroke="#000" stroke-width="2"/>
                        <text x="400" y="365" text-anchor="middle" font-size="20" font-family="serif">ä¸­åº­</text>
                        
                        <!-- æ­£å ‚ -->
                        <rect x="250" y="150" width="300" height="120" fill="none" stroke="#000" stroke-width="2"/>
                        <text x="400" y="215" text-anchor="middle" font-size="20" font-family="serif">æ­£å ‚</text>
                        
                        <!-- å·¦å³å»‚æˆ¿ -->
                        <rect x="100" y="200" width="80" height="200" fill="none" stroke="#000" stroke-width="2"/>
                        <text x="140" y="305" text-anchor="middle" font-size="16" font-family="serif" writing-mode="tb">æ±å»‚</text>
                        
                        <rect x="620" y="200" width="80" height="200" fill="none" stroke="#000" stroke-width="2"/>
                        <text x="660" y="305" text-anchor="middle" font-size="16" font-family="serif" writing-mode="tb">è¥¿å»‚</text>
                        
                        <!-- å±‹é ‚ç·šæ¢ -->
                        <path d="M 250 150 L 400 100 L 550 150" fill="none" stroke="#000" stroke-width="2"/>
                        <path d="M 200 300 L 400 250 L 600 300" fill="none" stroke="#000" stroke-width="2"/>
                        
                        <!-- æ¨™é¡Œ -->
                        <text x="750" y="100" text-anchor="end" font-size="24" font-family="serif" writing-mode="tb">ç¸£ç½²åœ–</text>
                        <text x="50" y="580" font-size="16" font-family="serif">å°ç£ç¸£ç½² (1807å¹´ã€ŠçºŒä¿®å°ç£ç¸£èªŒã€‹)</text>
                        
                        <!-- è£é£¾æ€§å…ƒç´  -->
                        <circle cx="400" cy="360" r="30" fill="none" stroke="#000" stroke-width="1"/>
                        <rect x="385" y="345" width="30" height="30" fill="none" stroke="#000" stroke-width="1"/>
                    </svg>
                `;
                document.getElementById('countyImage').src = 
                    'data:image/svg+xml,' + encodeURIComponent(svgContent);
                
                // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ
                playSound('victory');
            } else {
                // è¨˜éŒ„éŠæˆ²å¤±æ•—
                trackAction('game_failed', '', `æ™‚é–“åˆ°ï¼Œè€—æ™‚${totalTime}ç§’`);
                
                // ç™¼é€å®Œæ•´éŠæˆ²è¨˜éŒ„
                sendGameSummary(false, totalTime);
                
                alert(`
                    â° æ™‚é–“åˆ°äº†ï¼
                    
                    ä½ è¢«å›°åœ¨æ™‚å…‰å¯†å®¤è£¡äº†...
                    
                    ğŸ’¡ å°æç¤ºï¼š
                    1. é»æ“Šç™¼å…‰çš„ç‰©å“æ”¶é›†ç·šç´¢
                    2. ä»”ç´°è§€å¯Ÿæ¯å€‹è¬é¡Œçš„æç¤º
                    3. è¨˜ä½ï¼š1684ã€å°ç£ç¸£ç½²ã€èµ¤å´ã€æ±åŒ—æ–¹
                    
                    å†è©¦ä¸€æ¬¡å§ï¼
                `);
                
                // é‡æ–°é–‹å§‹
                restartGame();
            }
        }
        
        // ç™¼é€éŠæˆ²ç¸½çµ
        function sendGameSummary(completed, totalTime) {
            const summary = {
                playerId: gameState.playerId,
                actionType: 'game_summary',
                itemName: '',
                scene: 'final',
                gameTime: totalTime,
                note: JSON.stringify({
                    completed: completed,
                    totalActions: gameState.actions.length,
                    itemsCollected: gameState.inventory.length,
                    puzzlesSolved: Object.values(gameState.puzzlesSolved).filter(v => v).length
                })
            };
            
            sendToGoogleSheets(summary);
        }

        // é‡æ–°é–‹å§‹éŠæˆ²
        function restartGame() {
            location.reload();
        }

        // é›¢é–‹éŠæˆ²
        function exitGame() {
            if (confirm('ç¢ºå®šè¦é›¢é–‹éŠæˆ²å—ï¼Ÿ')) {
                // å˜—è©¦é—œé–‰è¦–çª—ï¼Œå¦‚æœç„¡æ³•é—œé–‰å‰‡å°å‘ç©ºç™½é 
                window.close();
                // å¦‚æœwindow.close()å¤±æ•—ï¼ˆå¤§å¤šæ•¸ç¾ä»£ç€è¦½å™¨æœƒé˜»æ­¢ï¼‰
                window.location.href = 'about:blank';
            }
        }

        // éŸ³æ•ˆå‡½æ•¸ï¼ˆç°¡åŒ–ç‰ˆï¼‰
        function playSound(type) {
            // ä½¿ç”¨ Web Audio API å‰µå»ºç°¡å–®çš„éŸ³æ•ˆ
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'start':
                    oscillator.frequency.value = 523.25; // C5
                    gainNode.gain.value = 0.3;
                    break;
                case 'collect':
                    oscillator.frequency.value = 659.25; // E5
                    gainNode.gain.value = 0.2;
                    break;
                case 'success':
                    oscillator.frequency.value = 783.99; // G5
                    gainNode.gain.value = 0.3;
                    break;
                case 'error':
                    oscillator.frequency.value = 293.66; // D4
                    gainNode.gain.value = 0.2;
                    break;
                case 'victory':
                    // å‹åˆ©éŸ³æ•ˆ - ä¸Šå‡éŸ³éš
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.linearRampToValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.linearRampToValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioContext.currentTime + 0.3); // C6
                    gainNode.gain.value = 0.4;
                    break;
            }
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + (type === 'victory' ? 0.4 : 0.2));
        }

        // åˆå§‹åŒ–
        window.onload = initGame;
        
        // æé†’è¨­å®š Google Apps Script URL
        if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
            console.warn('âš ï¸ è«‹è¨­å®š Google Apps Script Web App URL ä¾†å•Ÿç”¨è³‡æ–™è¿½è¹¤åŠŸèƒ½');
            console.log('ğŸ“Š ç›®å‰è³‡æ–™åªæœƒåœ¨æ§åˆ¶å°é¡¯ç¤ºï¼Œä¸æœƒå‚³é€åˆ° Google Sheets');
            console.log('ğŸ’¡ æç¤ºï¼šåœ¨æ§åˆ¶å°è¼¸å…¥ exportGameData() å¯ä»¥åŒ¯å‡ºæ‰€æœ‰è¿½è¹¤è³‡æ–™');
        }
        
        // è³‡æ–™åŒ¯å‡ºåŠŸèƒ½ï¼ˆä¾›æ¸¬è©¦ç”¨ï¼‰
        window.exportGameData = function() {
            console.log('=== éŠæˆ²è³‡æ–™åŒ¯å‡º ===');
            console.log('ç©å®¶ID:', gameState.playerId);
            console.log('ç¸½å‹•ä½œæ•¸:', gameState.actions.length);
            console.log('è©³ç´°è¨˜éŒ„:');
            console.table(gameState.actions);
            
            // ç”¢ç”ŸCSVæ ¼å¼
            const csv = [
                ['æ™‚é–“æˆ³è¨˜', 'å‹•ä½œé¡å‹', 'ç‰©ä»¶åç¨±', 'å ´æ™¯', 'éŠæˆ²æ™‚é–“', 'å‚™è¨»'],
                ...gameState.actions.map(a => [
                    a.timestamp,
                    a.actionType,
                    a.itemName,
                    a.scene,
                    a.gameTime,
                    a.note
                ])
            ].map(row => row.join(',')).join('\n');
            
            console.log('\n=== CSV æ ¼å¼è³‡æ–™ ===');
            console.log(csv);
            
            return gameState.actions;
        };
    </script>
</body>
</html>
