<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>時光偵探：尋找失落的台灣縣署</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    <style>
        #gameUI {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #clueNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,150,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        #gameIntro {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #gameIntro h2 {
            color: #4CC3D9;
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
        }
        #gameIntro h3 {
            color: #FFD700;
            margin-top: 20px;
            font-size: 20px;
        }
        #gameIntro h4 {
            color: #4CC3D9;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #gameIntro ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        #gameIntro li {
            margin: 10px 0;
            line-height: 1.5;
        }
        #gameIntro p {
            line-height: 1.6;
            margin: 8px 0;
        }
        #startButton {
            display: block;
            margin: 20px auto 0;
            padding: 15px 30px;
            background: #4CC3D9;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #startButton:hover {
            background: #3BA3B9;
        }
    </style>
</head>
<body>
    <!-- 遊戲說明介面 -->
    <div id="gameIntro">
        <h2>🕰️ 時光偵探：尋找失落的台灣縣署</h2>
        <h3>📖 故事背景</h3>
        <p>小偵探你好！台南市在赤崁樓附近挖到了古老的建築遺跡，我們需要你幫忙確認這是不是「台灣縣署」（古代的縣政府）！</p>
        
        <h3>🎮 怎麼玩？</h3>
        <ul>
            <li><strong>滑鼠/手把：</strong>看到亮亮的物品，對準它按一下就可以了！</li>
            <li><strong>移動：</strong>用搖桿走路，或點地板瞬間移動</li>
            <li><strong>觀察：</strong>靠近一點看會更清楚喔！</li>
        </ul>
        
        <h3>🎯 你的任務（共4關）</h3>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
            <h4>📍 第1關：考古現場</h4>
            <p><strong>任務：</strong>找到一塊石碑，用手指跟著描一次上面的數字</p>
            <p><strong>提示：</strong>石碑是灰色的大石頭，上面有「一六八四」</p>
            <p><strong>獎勵：</strong>得到線索「1684年」（台灣設府的年份）</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
            <h4>🏛️ 第2關：清朝縣署</h4>
            <p><strong>任務：</strong>找到牆上的詩，看看每句第一個字是什麼</p>
            <p><strong>提示：</strong>有四句詩，第一個字連起來就是答案</p>
            <p><strong>獎勵：</strong>得到線索「台灣縣署」（建築物的名字）</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
            <h4>🏫 第3關：日本時代教室</h4>
            <p><strong>任務：</strong>看黑板上的密碼，找出它代表的英文字</p>
            <p><strong>提示：</strong>摩斯密碼下面有答案（CHIKAN = 赤崁）</p>
            <p><strong>獎勵：</strong>得到線索「赤崁」（地名）</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
            <h4>🗺️ 第4關：最終任務</h4>
            <p><strong>任務：</strong>在3D地圖上，把金色圓球放到縣署的位置</p>
            <p><strong>提示：</strong>縣署在赤崁樓的右上方（東北邊）</p>
            <p><strong>獎勵：</strong>完成任務，發現縣署的秘密！</p>
        </div>
        
        <h3>⏱️ 時間</h3>
        <p style="font-size: 18px; color: #FFD700;">你有15分鐘，加油！每找到一個線索就會自動進入下一關。</p>
        
        <button id="startButton">我準備好了，開始遊戲！</button>
    </div>
    
    <div id="gameUI" style="display: none;">
        <h3>時光偵探：尋找失落的台灣縣署</h3>
        <p>場景: <span id="currentScene">考古現場</span></p>
        <p>收集線索: <span id="clueCount">0</span>/4</p>
        <p>時間: <span id="timer">15:00</span></p>
    </div>
    
    <div id="clueNotification"></div>

    <a-scene environment="preset: japan; groundColor: #445; grid: cross">
        <!-- 資源定義 -->
        <a-assets>
            <!-- 可以在這裡加入圖片或模型資源 -->
            <img id="mapTexture" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="map">
        </a-assets>

        <!-- 相機與控制器 -->
        <a-entity id="player" position="0 1.6 0">
            <a-camera>
                <a-cursor color="#4CC3D9"></a-cursor>
            </a-camera>
            <a-entity laser-controls="hand: right"></a-entity>
            <a-entity laser-controls="hand: left"></a-entity>
        </a-entity>

        <!-- 場景1: 考古現場 -->
        <a-entity id="scene1" visible="true">
            <!-- 考古區域地面 -->
            <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" 
                     color="#8B7355" roughness="0.8">
            </a-plane>
            
            <!-- 石碑 (軌跡解謎) -->
            <a-box id="stonePlate" position="-2 0.5 -4" width="1" height="1.5" depth="0.2"
                   color="#696969" class="clickable"
                   animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                   animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
                   animation__glow="property: material.emissiveIntensity; from: 0; to: 0.2; dir: alternate; dur: 1500; loop: true">
                <a-text value="點我！\n一六八四" position="0 0 0.11" align="center" 
                        color="white" width="4" font="kelsonsans"></a-text>
            </a-box>
            
            <!-- 考古工具 -->
            <a-cylinder id="brush" position="1 0.1 -3" radius="0.05" height="0.3"
                        color="#8B4513" rotation="0 0 90" class="grabbable">
            </a-cylinder>
            
            <!-- 1875年地圖 -->
            <a-image id="map1875" src="#mapTexture" position="3 2 -5" width="3" height="2"
                     class="clickable">
            </a-image>
            
            <!-- 場景說明牌 -->
            <a-text value="第1關：考古現場\n點一下灰色石碑" position="0 3 -4" 
                    align="center" color="white" width="8" background="color: black">
            </a-text>
        </a-entity>

        <!-- 場景2: 清朝縣署 -->
        <a-entity id="scene2" visible="false">
            <!-- 縣署建築 -->
            <a-box position="0 2 -6" width="8" height="4" depth="6" color="#8B4513">
                <a-text value="台灣縣署" position="0 2.1 3.01" align="center" 
                        color="gold" width="10"></a-text>
            </a-box>
            
            <!-- 藏頭詩牌匾 -->
            <a-plane id="poemBoard" position="0 2 -2.9" width="3" height="2" color="#333"
                     class="clickable">
                <a-text value="台島初設府\n灣岸築新城\n縣官理民事\n署內判公明" 
                        position="0 0 0.01" align="center" color="white" width="4"
                        line-height="60"></a-text>
            </a-plane>
            
            <!-- 官員NPC -->
            <a-cylinder position="-2 1 -4" radius="0.3" height="2" color="#4169E1">
                <a-sphere position="0 1.2 0" radius="0.3" color="#FDBCB4"></a-sphere>
            </a-cylinder>
            
            <!-- 場景說明 -->
            <a-text value="第2關：清朝縣署\n點一下牆上的詩" position="0 4 -4" 
                    align="center" color="white" width="8" background="color: black">
            </a-text>
        </a-entity>

        <!-- 場景3: 日治時期 -->
        <a-entity id="scene3" visible="false">
            <!-- 教室 -->
            <a-box position="0 2 -5" width="6" height="3" depth="5" color="#F5DEB3"
                   opacity="0.8">
            </a-box>
            
            <!-- 黑板 (摩斯密碼) -->
            <a-plane id="blackboard" position="0 2 -2.4" width="4" height="2" color="#2F4F2F"
                     class="clickable">
                <a-text value="摩斯密碼：\n-.-. .... .. -.- .- -.\n↓\n答案：CHIKAN (赤崁)" 
                        position="0 0 0.01" align="center" color="white" width="6" line-height="65"></a-text>
            </a-plane>
            
            <!-- 課桌椅 -->
            <a-box position="-1 0.5 -3" width="0.8" height="0.8" depth="0.6" 
                   color="#8B4513"></a-box>
            <a-box position="1 0.5 -3" width="0.8" height="0.8" depth="0.6" 
                   color="#8B4513"></a-box>
            
            <!-- 場景說明 -->
            <a-text value="第3關：日本時代教室\n點一下黑板" position="0 4 -4" 
                    align="center" color="white" width="8" background="color: black">
            </a-text>
        </a-entity>

        <!-- 場景4: 時空整合室 -->
        <a-entity id="scene4" visible="false">
            <!-- 3D地圖平台 -->
            <a-cylinder position="0 0.5 -4" radius="3" height="0.2" color="#1E90FF"
                        opacity="0.7">
            </a-cylinder>
            
            <!-- 赤崁樓模型 -->
            <a-box position="0 1 -4" width="1" height="0.8" depth="1" color="#DC143C">
                <a-text value="赤崁樓" position="0 0.5 0" align="center" 
                        color="white" width="3"></a-text>
            </a-box>
            
            <!-- 縣署位置標記 (需要玩家放置) -->
            <a-sphere id="countyMarker" position="2 1 -3" radius="0.2" color="#FFD700"
                      class="grabbable"
                      animation="property: position; to: 2 1.3 -3; dir: alternate; dur: 1000; loop: true">
                <a-text value="拖我到\n正確位置" position="0 0.5 0" align="center" 
                        color="black" width="3" background="color: yellow"></a-text>
            </a-sphere>
            
            <!-- 最終確認按鈕 -->
            <a-box id="confirmButton" position="0 1.5 -2" width="2" height="0.5" depth="0.1"
                   color="#32CD32" class="clickable">
                <a-text value="確認位置" position="0 0 0.06" align="center" 
                        color="white" width="5"></a-text>
            </a-box>
            
            <!-- 場景說明 -->
            <a-text value="第4關：最終任務\n把金球拖到赤崁樓的右上方，再按綠色按鈕" position="0 4 -4" 
                    align="center" color="white" width="10" background="color: black">
            </a-text>
        </a-entity>

        <!-- 額外光源增加亮度 -->
        <a-light type="ambient" color="#FFF" intensity="0.3"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.4" position="-0.5 1 1"></a-light>
    </a-scene>

    <script>
        // 遊戲狀態
        let gameState = {
            currentScene: 1,
            cluesFound: 0,
            timeRemaining: 900, // 15分鐘
            clues: {
                year1684: false,
                taiwanCounty: false,
                chikan: false,
                location: false
            }
        };

        let timerInterval;
        let gameStarted = false;

        // 確保 A-Frame 完全載入後再執行
        window.addEventListener('DOMContentLoaded', function() {
            // 等待 A-Frame 初始化
            if (typeof AFRAME === 'undefined') {
                console.log('等待 A-Frame 載入...');
                // 如果 AFRAME 還未定義，等待一下再試
                setTimeout(function() {
                    initializeGame();
                }, 1000);
            } else {
                initializeGame();
            }
        });

        function initializeGame() {
            // 簡單的抓取功能
            AFRAME.registerComponent('grabbable', {
                init: function() {
                    this.el.addEventListener('click', function(evt) {
                        // 簡化版：點擊後跟隨相機移動
                        console.log('物件被抓取');
                    });
                }
            });

            // 綁定開始按鈕
            document.getElementById('startButton').addEventListener('click', startGame);

            console.log('遊戲初始化完成！');
        }

        function startGame() {
            // 隱藏說明介面
            document.getElementById('gameIntro').style.display = 'none';
            // 顯示遊戲UI
            document.getElementById('gameUI').style.display = 'block';
            
            gameStarted = true;

            // 綁定所有互動事件
            setupEventListeners();

            // 啟動計時器
            startTimer();

            console.log('遊戲開始！');
        }

        function setupEventListeners() {
            // 互動事件
            document.getElementById('stonePlate').addEventListener('click', function() {
                collectClue('year1684');
            });

            document.getElementById('poemBoard').addEventListener('click', function() {
                collectClue('taiwanCounty');
            });

            document.getElementById('blackboard').addEventListener('click', function() {
                collectClue('chikan');
            });

            document.getElementById('confirmButton').addEventListener('click', function() {
                // 檢查縣署標記是否在正確位置
                const marker = document.getElementById('countyMarker');
                const markerPos = marker.getAttribute('position');
                
                // 簡化判定：只要在赤崁樓右邊就算對
                if (markerPos.x > 0.3) {
                    collectClue('location');
                    endGame(true);
                } else {
                    showNotification('再想想看！縣署在赤崁樓的「右邊」喔！');
                }
            });
        }

        function startTimer() {
            // 計時器
            timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                updateTimer();
                if (gameState.timeRemaining <= 0) {
                    endGame(false);
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // 線索收集
        function collectClue(clueName) {
            if (!gameState.clues[clueName]) {
                gameState.clues[clueName] = true;
                gameState.cluesFound++;
                document.getElementById('clueCount').textContent = gameState.cluesFound;
                showNotification(`✨ ${getClueText(clueName)}`);
                
                // 播放成功音效（使用簡單的beep聲）
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                audio.volume = 0.3;
                audio.play();
                
                // 檢查是否可以進入下一場景
                checkSceneProgress();
            }
        }

        function getClueText(clueName) {
            const clueTexts = {
                year1684: '找到了！1684年是台灣設立縣政府的年份',
                taiwanCounty: '太棒了！「台灣縣署」就是古代的縣政府',
                chikan: '解出來了！CHIKAN就是「赤崁」',
                location: '成功！縣署就在赤崁樓的東北邊'
            };
            return clueTexts[clueName] || clueName;
        }

        function showNotification(text) {
            const notification = document.getElementById('clueNotification');
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 場景切換
        function switchScene(sceneNum) {
            // 隱藏所有場景
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`scene${i}`).setAttribute('visible', false);
            }
            // 顯示目標場景
            document.getElementById(`scene${sceneNum}`).setAttribute('visible', true);
            gameState.currentScene = sceneNum;
            
            // 更新UI
            const sceneNames = ['', '第1關：挖挖看', '第2關：讀古詩', '第3關：解密碼', '第4關：找位置'];
            document.getElementById('currentScene').textContent = sceneNames[sceneNum];
        }

        function checkSceneProgress() {
            if (gameState.currentScene === 1 && gameState.clues.year1684) {
                showNotification('🎯 做得好！準備進入下一關...');
                setTimeout(() => switchScene(2), 2000);
            } else if (gameState.currentScene === 2 && gameState.clues.taiwanCounty) {
                showNotification('🎯 太棒了！前往下一個時代...');
                setTimeout(() => switchScene(3), 2000);
            } else if (gameState.currentScene === 3 && gameState.clues.chikan) {
                showNotification('🎯 最後一關！找出縣署的位置...');
                setTimeout(() => switchScene(4), 2000);
            }
        }

        // 遊戲結束
        function endGame(success) {
            if (!gameStarted) return;
            
            clearInterval(timerInterval);
            if (success) {
                showNotification('🎉 太厲害了！你找到台灣縣署了！');
                // 顯示縣署重建動畫
                setTimeout(() => {
                    const message = `
🎊 恭喜你完成任務！

你發現了什麼？
📍 台灣縣署就在赤崁樓的右上方（東北邊）
📍 現在那個位置是成功國小

小知識時間：
🏛️ 縣署 = 古代的縣政府
📅 1684年 = 台灣開始有縣政府
🏫 現在 = 變成了你們的學校！

你真是個優秀的時光偵探！
                    `;
                    alert(message);
                }, 3000);
            } else {
                alert('⏰ 時間到了！\n\n沒關係，再試一次吧！\n\n💡小提示：\n1. 記得點擊發亮的物品\n2. 石碑、詩、黑板都要點\n3. 金球要放在赤崁樓的右上方');
            }
        }
    </script>
</body>
</html>
